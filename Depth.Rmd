---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---


```{r setup}
#Packages
library(tidyverse)
library(cowplot)

#Files and directories 
dir_name = "/data2/alice/WW_project/"
data_dir = "/data2/alice/WW_project/0_Data/"
data_dir=paste0(dir_name, "0_Data/")
metadata_dir=paste0(dir_name, "Metadata/")
list_dir="/home/alice/WW_PopGen/Keep_lists_samples/"


#Analysis directories
#--------------------
VAR_dir = paste0(dir_name, "1_Variant_calling/")
  depth_per_window_dir = paste0(VAR_dir, "1_Depth_per_window/")
  depth_per_gene_dir = paste0(VAR_dir, "2_Depth_per_gene/")
  vcf_dir = paste0(VAR_dir, "4_Joint_calling/")

Zt_list = read_tsv("/home/alice/WW_PopGen/Keep_lists_samples/Ztritici_global_March2021.genotyped.sample_list.args", 
                   col_names = "ID_file")
metadata_cols = read_tsv("/home/alice/WW_PopGen/Keep_lists_samples/Main_table_from_SQL_Feb_2020_Description.tab", 
                         col_names = F) %>% pull()
metadata_file= read_tsv("/home/alice/WW_PopGen/Keep_lists_samples/Main_table_from_SQL_Feb_2020_with_collection.tab",
                        col_names = metadata_cols) 


Sys.setenv(WINDEPTH=depth_per_window_dir)


knitr::opts_chunk$set(message = F)
knitr::opts_chunk$set(warning = F)
knitr::opts_chunk$set(results = T)
```

#Depth per chromosome
I have run the depth per window for all chromosomes. From this data, I can extract summaries per chromosome per sample, per sample over the whole genome or per sample for the core chromosomes only.
```{bash summary depth, eval = F}
list_file=$(ls -1 ${WINDEPTH}*.depth_per_window.q30.txt )

#Per sample per chromosome
echo -e "Sample\tCHROM\tMedian\tMean" > ${WINDEPTH}Depth_per_chromosome_summary.q30.txt
for p in $list_file ; 
do 
  sed "s/:/\t/g" $p | ~/Software/bedtools groupby -g 1,2 -o median,mean -c 5; 
done >> ${WINDEPTH}Depth_per_chromosome_summary.q30.txt

#Per sample
echo -e "Sample\tMedian\tMean" > ${WINDEPTH}Depth_per_sample_summary.q30.txt
for p in $list_file ; 
do 
  sed "s/:/\t/g" $p | ~/Software/bedtools groupby -g 1 -o median,mean -c 5; 
done >> ${WINDEPTH}Depth_per_sample_summary.q30.txt

#Per sample on core chromosomes
echo -e "Sample\tMedian\tMean" > ${WINDEPTH}Depth_per_sample_core_chr_summary.q30.txt
for p in $list_file ; 
do 
  sed "s/:/\t/g" $p | \
    awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 < 14 {print}' | \
    ~/Software/bedtools groupby -g 1 -o median,mean -c 5 

done >>  ${WINDEPTH}Depth_per_sample_core_chr_summary.q30.txt

```

Such summaries per chromosomes are very useful to visualize if some samples have multiple copies of a chromosomes or the presence/absence of chromosomes in particular for the accessory chromosomes.
```{r CHR depth }

# Reading in the summarized data
core_depth = read_tsv(paste0(depth_per_window_dir, "Depth_per_sample_core_chr_summary.q30.txt")) %>%
  mutate(Median_core = Median) %>%
  inner_join(., Zt_list, by = c("Sample" = "ID_file"))
  
chrom_depth = read_tsv(paste0(depth_per_window_dir, "Depth_per_chromosome_summary.q30.txt")) %>%
  left_join(., core_depth %>% select(Sample, Median_core)) %>%
  mutate(Relative_depth = as.numeric(Median)/as.numeric(Median_core)) %>%
  inner_join(., Zt_list,  by = c("Sample" = "ID_file"))


# Heatmap of the depth per chromosome
heatmap_depth = chrom_depth %>%
  filter(CHROM != "mt") %>%
  ggplot(aes(x = as.numeric(CHROM), y=Sample, fill=Relative_depth)) +
  geom_tile() + scale_fill_gradient2(low="white", high = "#479DAE") +
  geom_vline(xintercept = 13.5, linetype = "longdash", colour = "gray20") +
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(), axis.ticks.y=element_blank()) +
  labs(fill = "Depth", x= "Chromosome") + xlim(c(0.5, 21.5))


# Estimation of low and high depth chromosomes
# (as proxy for present in 0 or multiple copies)
Lthres = 0.50
Hthres = 1.50
depth = chrom_depth %>%
  filter(CHROM != "mt") %>%
  dplyr::mutate(Depth_is = ifelse(Relative_depth > Hthres, "High",ifelse(Relative_depth < Lthres, "Low", "Normal")))

# Barplot
bar_Ndepth_per_CHR =ggplot(depth, aes(x = as.numeric(CHROM), fill = Depth_is)) +
  geom_bar(stat = "count") +
  scale_fill_manual(values = c("#16697a", "#82c0cc", "#EDE7E3")) +
    theme_light()+
    labs(x= "Chromosome", y = "Number of isolates")

# Lollipop plots
##For low normalized depth values
temp = depth %>%
  filter(Depth_is == "Low") %>%
  dplyr::group_by(CHROM) %>%
  dplyr::count()

lollow = ggplot(temp, aes(x = as.character(CHROM), y = n)) +
    geom_segment( aes(x=as.character(CHROM), xend=as.character(CHROM), y=0, yend=max(temp$n)),
                  color="grey80", size = 1) +
    geom_segment( aes(x=as.character(CHROM), xend=as.character(CHROM), y=0, yend=n),
                  color="grey20", size = 1) +
    geom_point( color="#82c0cc", size=4)  +
    geom_text(aes( label = n,
                     y= n), stat= "identity",
              hjust = -0.5, vjust = -0.2) +
    theme_light() +
    theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.x = element_text(size = 10),
    axis.text.y = element_text(size = 10)
    ) +
    ylim(c(0,max(temp$n)+ max(temp$n)*0.1)) +
    labs( x= "Chromosome", y = "Number of isolates without chromosome") +
    coord_flip()


# Gathering all 3 plots into a single figure
bottom_row <- cowplot::plot_grid(bar_Ndepth_per_CHR + theme(legend.position = "bottom"), lollow, 
                                 labels = c('B', 'C'), label_size = 12, ncol = 2)

cowplot::plot_grid(heatmap_depth, bottom_row, labels = c('A', ''), label_size = 12, ncol = 1)

```




# Depth per window and GC bias
I have used the bedtools nuc option to estimate the GC content per 1kb-window for the whole reference IPO323 genome 
```{r}
GC_per_window = read_tsv(paste0(data_dir, "Zymoseptoria_tritici.MG2.dna.toplevel.mt+.1kb_windows.nuc_GC.tab")) %>%
  mutate(GC = round(`5_pct_gc`, 2)) %>%
  filter( !is.na(`#1_usercol`))

temp = GC_per_window %>%
  filter(`#1_usercol` < 14)  %>%
  dplyr::select(CHROM = `#1_usercol`, Win_start = `2_usercol`, Win_stop = `3_usercol`, GC) %>%
  group_by(GC) %>%
  count() 

# Histogram of GC values
xint = median(GC_per_window$GC)
temp %>%
  ggplot(aes(x = GC, y = n, fill = n > 40)) +
    geom_bar(stat = "identity") +
    theme_light() +
  scale_fill_manual(values =c( "#82c0cc", "#EDE7E3"))+
  geom_vline(xintercept = xint, col = "#82c0cc") +
  annotate("text", label = paste0("Median GC is ", xint), 
           x = xint - xint*0.2, y = 5200, 
           size = 4, colour = "#82c0cc", fontface = "bold")

GC_avail = temp %>% filter(n > 40) %>% dplyr::select(GC) %>% pull()

random_GC_windows = GC_per_window %>%
  dplyr::select(CHROM = `#1_usercol`, Win_start = `2_usercol`, Win_stop = `3_usercol`, GC) %>%
  filter(GC %in% GC_avail)%>%
  group_by(GC) %>%
  sample_n(40) %>%
  mutate(CHROM = as.character(CHROM), 
         Win_start = as.character(Win_start), 
         Win_stop = as.character(Win_stop))
  
```
The distribution of GC is slightly skewed in the GC-rich side, with a median above 0.5. However, there is an AT-rich fat tail, or even a bimodal distribution. These windows are most probably containing RIP-affected repeated regions.

From there, we need to know if the different collections present GC bias in their sequencing. We expect a batch effect in the sequencing here since we have data coming from a lot of different years and labs (and because batch effect happens in general).
```{r Depth per win,  eval = F}

files <- list.files(depth_per_window_dir, pattern = "depth_per_window.q30.txt$", full.names = T)

depth_per_win = files %>%
  map_dfr(~read_tsv(., col_names = c("temp", "Depth")) %>%
                                            separate(col = temp, into = c("ID_file", "CHROM", "Win_start", "Win_stop"),
                                                     sep = ":") %>%
                                             inner_join(., random_GC_windows)) %>%
  left_join(., Zt_list)

write_tsv(depth_per_win, paste0(depth_per_window_dir, "Depth_for_GC_bias.txt"))
```


```{r GC bias}
depth_per_win = read_tsv(paste0(depth_per_window_dir, "Depth_for_GC_bias.txt"))

scale_this <- function(x){
  (x - mean(x, na.rm=TRUE)) / sd(x, na.rm=TRUE)
}


GC_coverage = depth_per_win %>%
  filter(Depth > 0) %>%
  group_by(ID_file) %>%
  dplyr::mutate(scaled_depth = scale_this(Depth)) %>%
  filter(!is.na(scaled_depth)) 


#GC bias estimation
getAlpha<-function(i){
  #print(i)
  temp = GC_coverage %>%
    filter(ID_file == i) #%>%
    #mutate(log_depth = log(Depth))
  
  if (nrow(temp) < 10) {
    return(NA)} else {
  linearMod <- lm(scaled_depth ~ GC, data=temp)  # build linear regression model on full data
  alpha = linearMod$coefficients["GC"]
  return (alpha)}}
v_getAlpha <- Vectorize(getAlpha)


GC_bias = GC_coverage %>%
  dplyr::select(ID_file) %>%
  distinct() %>%
  dplyr::mutate(GC_bias_slope = v_getAlpha(ID_file)) %>%
  left_join(., metadata_file %>% select(ID_file, Collection, Continent, Country, Region, 
                                        Sampling_Date, Latitude, Longitude))


write_tsv(GC_bias, paste0(depth_per_window_dir, "GC_bias_per_sample.txt"))

ggplot(GC_bias, aes(GC_bias_slope)) +
  geom_density() +
  theme_bw()

temp = GC_bias %>%
  filter(Collection != "\\N") %>%
  group_by(Collection) %>%
  count() %>%
  filter(n >= 20) 

#GC bias illustration
GC_coverage %>%
  filter(ID_file %in% sample(GC_coverage$ID_file, 15)) %>%
  ggplot(aes(GC, Depth)) +
    geom_point(col = "grey", alpha = 0.4) + 
    scale_fill_continuous(type = "viridis") +
    theme_bw() + facet_wrap(~ID_file, scale = "free") +
    geom_smooth(method = "lm", se = FALSE,
                color = "goldenrod", size= 0.7) +
    labs(x = "GC percent per window",
         y = "Depth per window",
         title = "Illustration of the GC bias",
         subtitle = "I use the slope of a linear model to infer the GC bias.")

#GC bias per collection
GC_bias_violins = inner_join(temp, GC_bias) %>%
  group_by(Collection) %>%
  mutate(Median = median(GC_bias_slope)) %>%
 ggplot(., aes(x = reorder(Collection, Median), y = GC_bias_slope, fill = reorder(Collection, Median))) +
  geom_violin(alpha = .7) +
  theme_bw()  +
  theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1),
        plot.margin = unit(c(0.5, 0.5, 0.5, 1), "cm")) +
  labs(x = "Collection", y = "GC bias estimate")
GC_bias_violins

```
It is very clear that we do have a batch effect but also that some datasets are very, very biased. The older Hartmann data (also called Qst population) in particular is strongly biased.



# Depth per gene
Aside from the depth per window, I have also estimated the depth of coverage per gene. I want to infer some gene presence/absence based on the depth so I need to normalize the depth. I have tried to normalize simply based on the depth over the core chromosomes in general, but this resulted in a median normalized depth per gene at 1.1 instead of 1 as expected. This is probably due to lower coverage in intergenic regions (in particular repeated regions that might be more suspectible to being deleted in some strains). The overall coverage for the chromosome would thus be lower than the coverage for the genes of the same chromosome. 

I have chosen to normalize using the median depth of genes for the core chromosomes. This resulted in a normalized depth with a median around one as shown with a sample of 4 isolates. 
```{r visual sample}
files <- list.files(depth_per_gene_dir, pattern = "depth_per_gene.q30.txt$", full.names = T)

depth_per_gene = sample(files, size = 4)  %>%
  map_dfr(~read_tsv(., col_names = c("temp", "Depth")) %>%
               separate(col = temp, into = c("Sample", "CHROM", "Gene"), sep = ":")) %>%
  left_join(., metadata_file, c("Sample" = "ID_file"))

temp = depth_per_gene %>%
  filter(str_detect(Gene, "_TU_"))  %>% 
  filter( !str_detect(Gene, "Parent")) %>%
  filter(as.numeric(CHROM) < 14) %>%
  group_by(Sample) %>%
  summarize(Median_core = median(Depth))

depth_per_gene %>%
  inner_join(., temp) %>%
  mutate(Norm_median_depth = Depth / Median_core) %>% 
  filter(str_detect(Gene, "_TU_"))  %>% 
  filter( !str_detect(Gene, "Parent")) %>%
  ggplot(aes(x = Norm_median_depth, fill = Sample, col = Sample)) +
  geom_density(alpha = 0.4) +
  geom_vline(xintercept = 1, col = "black", linetype = "dashed") +
  facet_wrap(vars(as.numeric(CHROM)), scales ="free") +
  theme_bw()+ 
  labs(title = "Normalized with the depth of the core chromosomes genes",
       x = "Normalized depth of coverage per gene")
```
Once I am confident that the normalization I am using is appropriate, I do this for all genes.
```{r norm gene depth, results = F, warning=F, eval = F}
files <- list.files(depth_per_gene_dir, pattern = "depth_per_gene.q30.txt$", full.names = T)

depth_per_gene = files %>%
  map_dfr(~read_tsv(., col_names = c("temp", "Depth")) %>%
               separate(col = temp, into = c("Sample", "CHROM", "Gene"), sep = ":")) 

temp = depth_per_gene %>%
  filter(str_detect(Gene, "_TU_"))  %>% 
  filter( !str_detect(Gene, "Parent")) %>%
  filter(as.numeric(CHROM) < 14) %>%
  group_by(Sample) %>%
  summarize(Median_core = median(Depth))

depth_per_gene = depth_per_gene %>%
  inner_join(., temp) %>%
  mutate(Norm_median_depth = round(Depth / Median_core, 2)) %>%
  filter(str_detect(Gene, "_TU_"))  %>% 
  filter( !str_detect(Gene, "Parent")) %>%
  separate(col = Gene, into = c("ID", "Name"), sep = ";") %>%
  select(-ID) %>%
  mutate(Name = str_replace(Name, "Name=", ""))

write_tsv(depth_per_gene, paste0(depth_per_gene_dir, "Depth_per_genes_normalized.txt"))

```


# Depth for resequencing pairs

```{r GC bias per pair}

depth_per_gene = read_tsv(paste0(depth_per_gene_dir, "Depth_per_genes_normalized.txt"))
repeat_seq = read_delim(paste0(list_dir, "Repeat_sequencing.txt"), col_names = c("Seq1", "Seq2"), delim = " ") %>%
  mutate(Pair = paste0("Pair_", c(1:length(Seq1)))) %>% 
  pivot_longer(-Pair, names_to = "temp", values_to = "ID_file") %>% 
  #dplyr::select(-temp) %>%
  left_join(., GC_bias) %>%
  mutate(Collection = ifelse(is.na(Collection), "ETHZ_2020", Collection))

repeat_collec = unique(repeat_seq$Collection)

depth_per_gene %>% 
  select(Sample, Median_core) %>%
  distinct() %>%
  inner_join(., GC_bias, by = c("Sample" = "ID_file")) %>%
  filter(Collection %in% repeat_collec) %>%
  group_by(Collection) %>%
  mutate(Median = median(GC_bias_slope)) %>%
 ggplot(.) +
  geom_violin(aes(x = reorder(Collection, Median), y = GC_bias_slope), alpha = .7) +
  theme_bw()  +
  theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1),
        plot.margin = unit(c(0.5, 0.5, 0.5, 1), "cm")) +
  labs(x = "Collection", y = "GC bias estimate") +
  geom_point(data = repeat_seq, aes(col = Pair, x = Collection, y = GC_bias_slope))


temp2 = repeat_seq %>% 
  dplyr::select(Pair, temp, GC_bias_slope) %>% p
ivot_wider(names_from = temp, values_from = GC_bias_slope)

pair_GC_plot = ggplot(data = repeat_seq, aes(y = Pair, x = GC_bias_slope)) + 
  geom_point(aes(col = Collection)) + 
  geom_segment(data = temp2, aes(y = Pair, yend = Pair, x = Seq1, xend = Seq2)) + 
  theme_bw() +
  labs(x = "GC bias estimation", y = element_blank())
  
```

```{r TE vs GCbias}
TE = read_delim("/data2/alice/WW_project/4_TE_RIP/0_RIP_estimation/Nb_reads_repeat_sequencing.txt", delim = " ") %>%
  mutate(Percent_TE_reads = 100*Te_aligned_reads/Genome_aligned_reads) %>%
  inner_join(repeat_seq)

#Plot TE content
seg_TE = TE %>% dplyr::select(Pair, temp, Percent_TE_reads) %>% pivot_wider(names_from = temp, values_from = Percent_TE_reads)
pair_TE_plot = ggplot(data = TE, aes(y = Pair, x = Percent_TE_reads)) + 
  geom_point(aes(col = Collection)) + 
  geom_segment(data = seg_TE, aes(y = Pair, yend = Pair, x = Seq1, xend = Seq2)) + 
  theme_bw() +
  labs(x = "TE content estimation", y = element_blank())

#Get legend and put plots together
legend = get_legend(pair_GC_plot + theme(legend.position = "bottom"))

row_plot = cowplot::plot_grid(pair_GC_plot + theme(legend.position = "none"),
                              pair_TE_plot + theme(legend.position = "none"),
                              ncol = 2, labels = c("A", "B"))

cowplot::plot_grid(row_plot, legend, rel_heights = c(10, 1), ncol = 1)
```


```{r CNV comparison}

genes_pairs = paste0(depth_per_gene_dir, unique(repeat_seq$ID_file), ".depth_per_gene.q30.txt") %>%
  map_dfr(~read_tsv(., col_names = c("temp", "Depth")) %>%
               separate(col = temp, into = c("ID_file", "CHROM", "Gene"), sep = ":")) 


temp = genes_pairs %>%
  filter(str_detect(Gene, "_TU_"))  %>% 
  filter( !str_detect(Gene, "Parent")) %>%
  filter(as.numeric(CHROM) < 14) %>%
  group_by(ID_file) %>%
  summarize(Median_core = median(Depth))

genes_pairs = genes_pairs %>%
  inner_join(., temp) %>%
  #mutate(Norm_median_depth = round(Depth / Median_core)) %>%
  mutate(Norm_median_depth = ifelse(Depth / Median_core < 0.25, 0, 
                                    ifelse(Depth / Median_core > 1.75, 2, 1))) %>%
  filter(str_detect(Gene, "_TU_"))  %>% 
  filter( !str_detect(Gene, "Parent")) %>%
  separate(col = Gene, into = c("ID", "Name"), sep = ";") %>%
  select(-ID) %>%
  mutate(Name = str_replace(Name, "Name=", "")) %>% 
  full_join(., repeat_seq)

temp = genes_pairs %>%
  dplyr::select(Pair, temp, Name, Norm_median_depth) %>%
  pivot_wider(names_from = temp, values_from = Norm_median_depth) %>%
  mutate(diff = abs(Seq1 - Seq2))

p1 = temp %>% 
  group_by(Pair) %>%
  count(diff) %>%
  pivot_wider(names_from = diff, values_from = n) %>% 
   ggplot(aes(x = Pair, y = `1`, fill = Pair)) + 
   geom_bar(stat = "identity") + 
   theme_bw() +
   labs(y = "Number of genes", x = "",
        subtitle = "Genes with a different CNV value per pair") 


p2 = temp %>% 
   filter(diff > 0) %>% 
   group_by(Name) %>% 
   count() %>% 
   ggplot(aes(n)) + 
   geom_histogram(bins = 6) + 
   theme_bw() +
   labs(y = "Number of genes", x = "Number of pairs",
        subtitle = "Genes with a difference CNV value shared between pairs") 
 
row1 = cowplot::plot_grid(p1 + theme(legend.position = "none"), p2, ncol = 2, labels = c("A", "B"))


p3 = genes_pairs %>%
  filter(Norm_median_depth != 1) %>%
  group_by(ID_file, Norm_median_depth) %>%
  count()%>% 
   ggplot(aes(x = ID_file, y = n, fill = as.character(Norm_median_depth))) + 
   geom_bar(stat = "identity") + 
   theme_bw() +
  theme(axis.text.x = element_text(angle = 25, hjust = 1, vjust = 1),
        plot.margin = unit(c(0.5, 0.5, 0.5, 1.5), "cm")) +
  labs(y = "Number of genes", x = element_blank(),
       fill = "CNV")
  
cowplot::plot_grid(row1, p3, ncol =1, labels = c("", "C"))
```